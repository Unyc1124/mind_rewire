name: Deploy to cPanel (via SSH, archive & copy)

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build (optional) â€” install composer/npm if needed
        run: |
          # uncomment if you use composer/npm
          # if [ -f composer.json ]; then composer install --no-dev --optimize-autoloader --no-interaction; fi
          # if [ -f package.json ]; then npm ci && npm run build; fi
          echo "Build step done"

      - name: Create deployment archive
        run: |
          TIMESTAMP=$(date +%s)
          TARFILE="deploy_$TIMESTAMP.tar.gz"
          # exclude .git and node_modules optionally
          tar --exclude='.git' --exclude='node_modules' -czf $TARFILE .
          echo "TARFILE=$TARFILE" >> $GITHUB_ENV

      - name: Upload archive to server
        uses: appleboy/scp-action@master
        with:
          host: sg2plzcpnl509270.prod.sin2.secureserver.net   # your cPanel host
          username: ahvmt0d58za5                              # your cPanel username
          key: ${{ secrets.CPANEL_DEPLOY_KEY }}
          port: 22
          source: ${{ env.TARFILE }}
          target: /tmp/

      - name: Extract archive and deploy on server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: sg2plzcpnl509270.prod.sin2.secureserver.net
          username: ahvmt0d58za5
          key: ${{ secrets.CPANEL_DEPLOY_KEY }}
          port: 22
          script: |
            set -e
            TARFILE=$(basename "${{ env.TARFILE }}")
            cd /home/ahvmt0d58za5 || exit 1
            # backup current site (optional)
            rm -rf /home/ahvmt0d58za5/public_html_backup || true
            mv public_html public_html_backup || true
            mkdir -p public_html
            # extract uploaded tar into public_html
            tar -xzf /tmp/$TARFILE -C public_html
            # fix permissions (if needed)
            find public_html -type f -exec chmod 644 {} \;
            find public_html -type d -exec chmod 755 {} \;
            # cleanup
            rm /tmp/$TARFILE || true


